<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // Check if user is NOT logged in
        if (!localStorage.getItem('currentUser')) {
            // If no user found, force them back to login page
            // .replace() prevents them from hitting "Back" to return here
            window.location.replace("login.html");
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kapitthavaja Airlines Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <script>
        // --- 1. NAVIGATION LOGIC ---
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(div => {
                div.style.display = 'none';
                div.classList.remove('active-section');
            });
            const activeDiv = document.getElementById(sectionId);
            activeDiv.style.display = 'block';
            setTimeout(() => activeDiv.classList.add('active-section'), 10);

            // Update Active Link in Navbar
            document.querySelectorAll('.nav-links button').forEach(btn => {
                btn.classList.remove('active-btn');
            });
            // Highlight the correct button based on section
            if(sectionId === 'home') document.querySelector("button[onclick=\"showSection('home')\"]").classList.add('active-btn');
            if(sectionId === 'profile') document.querySelector("button[onclick=\"showSection('profile')\"]").classList.add('active-btn');
            if(sectionId === 'trips') document.querySelector("button[onclick=\"showSection('trips')\"]").classList.add('active-btn');
        }

        function logout() {
            if(confirm("Are you sure you want to sign out?")) {
                localStorage.removeItem('currentUser');
                window.location.replace("login.html");
            }
        }

        // --- 2. US007: SEARCH & DROPDOWN LOGIC ---
        function toggleDropdown(listId) {
            document.querySelectorAll('.dropdown-content').forEach(d => {
                if(d.id !== listId) d.classList.remove('show');
            });
            document.getElementById(listId).classList.toggle("show");
        }

        function selectOption(displayId, value, listId) {
            document.getElementById(displayId).innerText = value;
            document.getElementById(displayId).style.color = "white"; 
            document.getElementById(listId).classList.remove("show");
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn') && !event.target.matches('.dropdown-btn *')) {
                document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
            }
        }

        function validateSearch() {
            const origin = document.getElementById('originText').innerText;
            const destination = document.getElementById('destText').innerText;
            const dateVal = document.getElementById('deptDate').value;
            const travellers = document.getElementById('travellers').value;
            
            if (origin.includes("Select Origin")) { alert("Error: Please select an Origin city."); return; }
            if (destination.includes("Select Destination")) { alert("Error: Please select a Destination city."); return; }
            if (!dateVal) { alert("Error: Please select a Departure Date."); return; }
            if (!travellers || travellers < 1) { alert("Error: Enter at least 1 traveller."); return; }
            if (origin === destination) { alert("Error: Origin and Destination cannot be the same!"); return; }

            const selectedDate = new Date(dateVal);
            const today = new Date();
            today.setHours(0,0,0,0);
            if (selectedDate < today) { alert("Error: You cannot select a past date."); return; }

            // Show Mock Results
            document.getElementById('searchFormSection').style.display = 'none';
            document.getElementById('searchResultsSection').style.display = 'block';
            
            const resultsDiv = document.getElementById('resultsList');
            resultsDiv.innerHTML = `
                <div class="boarding-pass" style="width:100%; margin-bottom:20px;">
                    <div class="pass-left">
                        <div class="airline-name">PUSHP. VIMAAN</div>
                        <div class="flight-route"><h1>${origin.substring(0,3).toUpperCase()}</h1> <i class='bx bxs-plane'></i> <h1>${destination.substring(0,3).toUpperCase()}</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>PV-101</div><div><span>DATE</span><br>${dateVal}</div><div><span>TIME</span><br>10:00 AM</div></div>
                    </div>
                    <div class="pass-right"><div class="seat-info"><span>PRICE</span><h1>$450</h1></div><button onclick="alert('Booking Confirmed!')" style="background:white; color:#4facfe; border:none; padding:5px; border-radius:5px; cursor:pointer; font-weight:bold;">BOOK</button></div>
                </div>
            `;
        }

        function backToSearch() {
            document.getElementById('searchFormSection').style.display = 'block';
            document.getElementById('searchResultsSection').style.display = 'none';
        }

        // --- 3. TRIP TABS LOGIC ---
        function filterTrips(status) {
            document.querySelectorAll('.trip-list').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active-tab'));
            
            // Use flex to keep horizontal layout
            document.getElementById(status).style.display = 'flex'; 
            event.currentTarget.classList.add('active-tab');
        }

        // --- PROFILE EDIT LOGIC ---
        // --- PROFILE EDIT & SAVE LOGIC (Strict Rules) ---
        function enableEdit() {
            const ids = ['dispName', 'dispEmail', 'dispDob', 'dispContact'];
            ids.forEach(id => {
                const element = document.getElementById(id);
                element.contentEditable = "true";
                element.classList.add('editable-field'); 
            });
            document.getElementById('dispName').focus();
            alert("EDIT MODE: Click on any detail to change it.");
        }

        function saveProfile() {
            // 1. Capture the new values
            const newName = document.getElementById('dispName').innerText.trim();
            const newEmail = document.getElementById('dispEmail').innerText.trim();
            const newDob = document.getElementById('dispDob').innerText.trim(); 
            const newContact = document.getElementById('dispContact').innerText.trim();

            // --- 2. VALIDATION RULES ---

            // --- RULE A: NAME (SMART HEURISTICS) ---
            const nameRegex = /^[A-Za-z\s]+$/;
            if (!nameRegex.test(newName)) {
                alert("ERROR: Name must contain only alphabets.");
                return;
            }

            // Split name into parts to check each word
            const nameParts = newName.split(" ").filter(part => part.length > 0);
            
            // 1. Min Length
            if (newName.length < 3) {
                alert("ERROR: Name is too short. Please enter your full name.");
                return;
            }

            // 2. Junk Words List
            const junkWords = ['test', 'demo', 'admin', 'user', 'fart', 'stupid', 'dummy', 'abcd', 'xyz', 'qwer', 'asdf', 'none', 'null'];
            
            for (let part of nameParts) {
                // Check for Junk Words
                if (junkWords.includes(part.toLowerCase())) {
                    alert("ERROR: '" + part + "' is not a valid name. Please enter your real name.");
                    return;
                }
                // Check for Repeating Characters (e.g., "tttt", "aaaa") - 3 times in a row
                if (/(.)\1\1/.test(part)) {
                    alert("ERROR: Name looks fake (too many repeating characters like '" + part + "').");
                    return;
                }
                // Check for Consonant Smashes (e.g., "trrrrq" - no vowels for 5 chars)
                if (/[bcdfghjklmnpqrstvwxyz]{5,}/i.test(part)) {
                    alert("ERROR: Name looks unpronounceable (" + part + ").");
                    return;
                }
            }

            // --- RULE B: CONTACT (Strict India Mobile) ---
            const phoneRegex = /^[6-9]\d{9}$/;
            if (!phoneRegex.test(newContact)) {
                alert("ERROR: Invalid Contact! Must be 10 digits and start with 6, 7, 8, or 9.");
                return;
            }
            // Block repeating numbers like 9999999999
            if (/(.)\1{5,}/.test(newContact)) {
                alert("ERROR: Contact number cannot be just repeating digits.");
                return;
            }

            // --- RULE C: EMAIL ---
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(newEmail)) {
                alert("ERROR: Invalid Email ID! (Example: user@gmail.com)");
                return;
            }

            // --- RULE D: DATE (18+ & > 1924) ---
            const inputDate = new Date(newDob);
            const today = new Date();
            const minDate = new Date('1924-01-01');
            today.setHours(0,0,0,0);

            if (isNaN(inputDate.getTime())) {
                alert("ERROR: Invalid Date Format! Please use YYYY-MM-DD.");
                return;
            }
            if (inputDate <= minDate) {
                alert("ERROR: Date must be after 01-01-1924.");
                return;
            }
            if (inputDate > today) {
                alert("ERROR: Date of Birth cannot be in the future!");
                return;
            }

            // Age Check (18+)
            let age = today.getFullYear() - inputDate.getFullYear();
            const monthDiff = today.getMonth() - inputDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < inputDate.getDate())) {
                age--;
            }
            if (age < 18) {
                alert("ERROR: You must be at least 18 years old. (Calculated Age: " + age + ")");
                return;
            }

            // --- 3. SAVE TO STORAGE ---
            const currentUser = JSON.parse(localStorage.getItem('registeredUser')) || {};
            
            currentUser.firstName = nameParts[0];
            currentUser.lastName = nameParts.slice(1).join(" ");
            currentUser.email = newEmail;
            currentUser.dob = newDob;
            currentUser.contact = newContact;

            localStorage.setItem('registeredUser', JSON.stringify(currentUser));
            
            // Update Welcome Message Immediately
            document.getElementById('welcomeMsg').innerText = "Captain " + currentUser.firstName;
            
            alert("SUCCESS: Profile Updated!");

            // Turn off Edit Mode
            const ids = ['dispName', 'dispEmail', 'dispDob', 'dispContact'];
            ids.forEach(id => {
                const element = document.getElementById(id);
                element.contentEditable = "false";
                element.classList.remove('editable-field');
            });
        }

        // --- 4. ONLOAD: LOAD USER & PROFILE DATA ---
        window.onload = function() {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                window.location.href = "login.html";
            } else {
                // Set Welcome Message
                document.getElementById('welcomeMsg').innerText = "Captain " + user;
                
                // RESTORED: Load Profile Data
                const storedData = localStorage.getItem('registeredUser');
                if (storedData) {
                    const data = JSON.parse(storedData);

                    if (document.getElementById('headerUserName')) {
                        document.getElementById('headerUserName').innerText = "Welcome " + data.firstName + " !!!";
                    }
                    // Check if elements exist before setting (safety check)
                    if(document.getElementById('dispName')) document.getElementById('dispName').innerText = data.firstName + " " + data.lastName;
                    if(document.getElementById('dispEmail')) document.getElementById('dispEmail').innerText = data.email;
                    if(document.getElementById('dispDob')) document.getElementById('dispDob').innerText = data.dob;
                    if(document.getElementById('dispContact')) document.getElementById('dispContact').innerText = data.contact;
                }
            }
        };
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="logo"><i class='bx bxs-plane-alt'></i> Kapitthavaja Airlines</div>
        <div class="nav-links">
            <button onclick="showSection('home')" class="active-btn">Dashboard</button>
            <button onclick="showSection('profile')">My Passport</button>
            <button onclick="showSection('trips')">Boarding Passes</button>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
    </nav>

    <div class="main-content">

        <header class="dashboard-header">
            <div class="user-profile-box">
                <div class="user-details">
                    <span class="header-name" id="headerUserName">Loading...</span>
                    <span class="header-status">Gold Tier | 52,000 Miles</span>
                </div>
                <i class='bx bxs-user-circle header-icon'></i>
            </div>
        </header>

        <div id="home" class="content-section active-section">
            <h1 id="welcomeMsg" class="welcome-title">Welcome Captain!</h1>
            <p class="subtitle">Ready for your next adventure?</p>
            
            <div class="dashboard-grid">
                <div class="card" onclick="showSection('book-flight')">
                    <i class='bx bxs-plane-take-off'></i>
                    <h3>Book Flight</h3>
                    <p>Search destinations</p>
                </div>
                <div class="card">
                    <i class='bx bxs-calendar-check'></i>
                    <h3>Check-In</h3>
                    <p>Get your seat</p>
                </div>
                <div class="card">
                    <i class='bx bxs-offer'></i>
                    <h3>Offers</h3>
                    <p>Exclusive deals</p>
                </div>
            </div>
        </div>

        <div id="book-flight" class="content-section" style="display:none;">
            <div id="searchFormSection">
                <h2 class="section-title">Find Your Flight</h2>
                <div class="register-container" style="margin: 0 auto; width: 500px;">
                    <form onsubmit="event.preventDefault(); validateSearch();">
                        
                        <div class="input-box">
                            <label style="font-size:12px; color:#4facfe; margin-left:15px;">ORIGIN</label>
                            <div class="custom-dropdown">
                                <div class="dropdown-btn" onclick="toggleDropdown('originList')">
                                    <span id="originText">Select Origin</span> <i class='bx bxs-chevron-down'></i>
                                </div>
                                <div id="originList" class="dropdown-content">
                                    <div onclick="selectOption('originText', 'Mumbai', 'originList')">Mumbai</div>
                                    <div onclick="selectOption('originText', 'Delhi', 'originList')">Delhi</div>
                                    <div onclick="selectOption('originText', 'Bangalore', 'originList')">Bangalore</div>
                                    <div onclick="selectOption('originText', 'Chennai', 'originList')">Chennai</div>
                                </div>
                            </div>
                        </div>

                        <div class="input-box">
                            <label style="font-size:12px; color:#4facfe; margin-left:15px;">DESTINATION</label>
                            <div class="custom-dropdown">
                                <div class="dropdown-btn" onclick="toggleDropdown('destList')">
                                    <span id="destText">Select Destination</span> <i class='bx bxs-chevron-down'></i>
                                </div>
                                <div id="destList" class="dropdown-content">
                                    <div onclick="selectOption('destText', 'New York', 'destList')">New York</div>
                                    <div onclick="selectOption('destText', 'London', 'destList')">London</div>
                                    <div onclick="selectOption('destText', 'Dubai', 'destList')">Dubai</div>
                                    <div onclick="selectOption('destText', 'Paris', 'destList')">Paris</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-box">
                                <label style="font-size:12px; color:#4facfe; margin-left:15px;">DATE</label>
                                <input type="date" id="deptDate" style="padding-left:20px;">
                            </div>
                            <div class="input-box">
                                <label style="font-size:12px; color:#4facfe; margin-left:15px;">TRAVELLERS</label>
                                <input type="number" id="travellers" min="1" value="1" style="padding-left:20px;">
                            </div>
                        </div>

                        <div class="input-box">
                            <label style="font-size:12px; color:#4facfe; margin-left:15px;">CLASS</label>
                            <select style="width:100%; padding:12px; border-radius:50px; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); color:white;">
                                <option>Economy</option>
                                <option>Executive</option>
                                <option>Business</option>
                            </select>
                        </div>

                        <button type="submit" class="btn" style="margin-top:20px;">Search Flights</button>
                    </form>
                </div>
            </div>

            <div id="searchResultsSection" style="display:none;">
                <h2 class="section-title">Available Flights</h2>
                <div id="resultsList" style="max-width:600px; margin:0 auto;"></div>
                <button onclick="backToSearch()" class="btn-secondary" style="margin-top:20px; padding:10px 20px; border-radius:30px;">Back to Search</button>
            </div>
        </div>

        <div id="profile" class="content-section" style="display:none;">
            <div class="passport-card">
                <div class="passport-header">
                    <i class='bx bxs-id-card'></i> OFFICIAL PASSENGER IDENTITY
                </div>
                <div class="passport-body">
                    <div class="photo-area">
                        <i class='bx bxs-user-circle' style="font-size: 100px; color: #4facfe;"></i>
                        <p>Passenger</p>
                    </div>
                    <div class="details-area">
                        <div class="detail-row">
                            <span>Full Name:</span>
                            <div id="dispName" class="data-field">Loading...</div>
                        </div>
                        <div class="detail-row">
                            <span>Email ID:</span>
                            <div id="dispEmail" class="data-field">Loading...</div>
                        </div>
                        <div class="detail-row">
                            <span>Date of Birth:</span>
                            <div id="dispDob" class="data-field">Loading...</div>
                        </div>
                        <div class="detail-row">
                            <span>Contact No:</span>
                            <div id="dispContact" class="data-field">Loading...</div>
                        </div>
                    </div>
                </div>
                <div class="passport-footer" style="padding: 20px; text-align: right; background: rgba(0,0,0,0.2);">
                    <button onclick="enableEdit()" class="btn-action">Edit Details</button>
                    <button onclick="saveProfile()" class="btn-action btn-save">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="trips" class="content-section" style="display:none;">
            <h2 class="section-title">Flight Logbook</h2>

            <div class="trip-tabs">
                <button onclick="filterTrips('confirmed')" class="tab-btn active-tab">Confirmed</button>
                <button onclick="filterTrips('cancelled')" class="tab-btn">Cancelled</button>
                <button onclick="filterTrips('completed')" class="tab-btn">Completed</button>
            </div>
            
            <div id="confirmed" class="trip-list">
                <div class="boarding-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>BOM</h1> <i class='bx bxs-plane'></i> <h1>NYC</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-909</div><div><span>DATE</span><br>12 OCT 2026</div><div><span>GATE</span><br>A4</div></div>
                    </div>
                    <div class="pass-right"><div class="seat-info"><span>SEAT</span><h1>4A</h1></div><i class='bx bx-barcode' style="font-size: 50px;"></i></div>
                </div>
                <div class="boarding-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>DEL</h1> <i class='bx bxs-plane'></i> <h1>LHR</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-101</div><div><span>DATE</span><br>15 NOV 2026</div><div><span>GATE</span><br>B2</div></div>
                    </div>
                    <div class="pass-right"><div class="seat-info"><span>SEAT</span><h1>12C</h1></div><i class='bx bx-barcode' style="font-size: 50px;"></i></div>
                </div>
                <div class="boarding-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>BLR</h1> <i class='bx bxs-plane'></i> <h1>DXB</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-303</div><div><span>DATE</span><br>20 MAR 2026</div><div><span>GATE</span><br>C1</div></div>
                    </div>
                    <div class="pass-right"><div class="seat-info"><span>SEAT</span><h1>1F</h1></div><i class='bx bx-barcode' style="font-size: 50px;"></i></div>
                </div>
            </div>

            <div id="cancelled" class="trip-list" style="display:none;">
                <div class="boarding-pass cancelled-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>DEL</h1> <i class='bx bxs-plane'></i> <h1>PNQ</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-001</div><div><span>DATE</span><br>10 DEC 2023</div><div><span>STATUS</span><br><b style="color:red;">CANCELLED</b></div></div>
                    </div>
                    <div class="pass-right" style="background-color: #ff4b4b;"><i class='bx bx-block' style="font-size: 40px; color:white;"></i><span style="font-size:12px; margin-top:5px;">REFUNDED</span></div>
                </div>
                <div class="boarding-pass cancelled-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>BOM</h1> <i class='bx bxs-plane'></i> <h1>GOA</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-002</div><div><span>DATE</span><br>05 NOV 2024</div><div><span>STATUS</span><br><b style="color:red;">CANCELLED</b></div></div>
                    </div>
                    <div class="pass-right" style="background-color: #ff4b4b;"><i class='bx bx-block' style="font-size: 40px; color:white;"></i><span style="font-size:12px; margin-top:5px;">REFUNDED</span></div>
                </div>
                <div class="boarding-pass cancelled-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>MAA</h1> <i class='bx bxs-plane'></i> <h1>HYD</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-003</div><div><span>DATE</span><br>01 OCT 2025</div><div><span>STATUS</span><br><b style="color:red;">CANCELLED</b></div></div>
                    </div>
                    <div class="pass-right" style="background-color: #ff4b4b;"><i class='bx bx-block' style="font-size: 40px; color:white;"></i><span style="font-size:12px; margin-top:5px;">OPERATOR</span></div>
                </div>
            </div>

            <div id="completed" class="trip-list" style="display:none;">
                <div class="boarding-pass completed-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>LHR</h1> <i class='bx bxs-plane'></i> <h1>BOM</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-777</div><div><span>DATE</span><br>15 AUG 2023</div><div><span>STATUS</span><br><b style="color:green;">LANDED</b></div></div>
                    </div>
                    <div class="pass-right" style="background-color: #33f906;"><i class='bx bxs-check-circle' style="font-size: 40px; color:white;"></i></div>
                </div>
                <div class="boarding-pass completed-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>FRA</h1> <i class='bx bxs-plane'></i> <h1>DEL</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-888</div><div><span>DATE</span><br>10 JUL 2024</div><div><span>STATUS</span><br><b style="color:green;">LANDED</b></div></div>
                    </div>
                    <div class="pass-right" style="background-color: #33f906;"><i class='bx bxs-check-circle' style="font-size: 40px; color:white;"></i></div>
                </div>
                <div class="boarding-pass completed-pass">
                    <div class="pass-left">
                        <div class="airline-name">KAPITT. VIMAAN</div>
                        <div class="flight-route"><h1>JFK</h1> <i class='bx bxs-plane'></i> <h1>BOM</h1></div>
                        <div class="flight-details"><div><span>FLIGHT</span><br>KV-999</div><div><span>DATE</span><br>01 JUN 2025</div><div><span>STATUS</span><br><b style="color:green;">LANDED</b></div></div>
                    </div>
                    <div class="pass-right" style="background-color: #33f906"><i class='bx bxs-check-circle' style="font-size: 40px; color:white;"></i></div>
                </div>
            </div>

        </div>

    </div>
</body>
</html>